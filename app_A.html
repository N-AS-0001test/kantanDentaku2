<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>電卓アプリA（バグ仕込み版）</title>
  <!-- Vue.js（CDNによる読み込み） -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
  <script src="vue.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    #app {
      width: 320px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      border-radius: 10px;
      overflow: hidden;
    }
    .display {
      background: #222;
      color: #0f0;
      font-size: 2em;
      text-align: right;
      padding: 20px;
      box-sizing: border-box;
    }
    .buttons {
      display: grid; /* ボタン部はCSSグリッドレイアウトを使用 */
      grid-template-columns: repeat(4, 1fr); /* 列は4列 */
      grid-template-rows: repeat(6, 60px);   /* 行は6行 */
      gap: 1px;
      background: #aaa;
    }
    button {
      font-size: 1.2em;
      border: none;
      background: #fff;
      cursor: pointer;
    }
    button:active {
      background: #bbb;
    }
    .plus {
      grid-row: span 2;
      background: #f90;
      color: #fff;
    }
    .operator {
      background: #f0f0f0;
    }
    .memory {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 表示領域 -->
    <div class="display">{{ display }}</div>
    <!-- ボタン領域（CSSグリッドレイアウトでボタン配置） -->
    <div class="buttons">
      <button class="memory" @click="memoryAdd">M+</button>
      <button class="memory" @click="memorySubtract">M-</button>
      <button class="memory" @click="memoryRecall">MR</button>
      <button class="memory" @click="memoryClear">MC</button>

      <button class="operator" @click="clearAll">AC</button>
      <button class="operator" @click="clearEntry">CE</button>
      <button class="operator" @click="input('%')">%</button>
      <button class="operator" @click="input('/')">÷</button>

      <button @click="input('7')">7</button>
      <button @click="input('8')">8</button>
      <button @click="input('9')">9</button>
      <button class="operator" @click="input('*')">×</button>

      <button @click="input('4')">4</button>
      <button @click="input('5')">5</button>
      <button @click="input('6')">6</button>
      <button class="operator" @click="input('-')">−</button>

      <button @click="input('1')">1</button>
      <button @click="input('2')">2</button>
      <button @click="input('3')">3</button>
      <button class="plus" @click="input('+')">＋</button>

      <button @click="input('0')">0</button>
      <button @click="input('.')">.</button>
      <button @click="calculate">＝</button>
    </div>
  </div>

  <script>
    const maxLength = 12;           // 画面表示の最大長(12桁:固定値)
    new Vue({
      el: '#app',
      data: {
        current: '0',               // 現在の表示値
        memory: 0,                  // メモリ記憶値
        previous: null,             // 演算子の前の入力値
        operator: null,             // 演算子
        waitingForNext: false       // 演算子の次の値の入力待ち状態
      },
      computed: {
        // 画面表示
        display() {
          console.log("display : " + this.current);
          return this.current;
        }
      },
      methods: {
        // ボタン入力
        input(char) {
          console.log("input : " + char);
          if ('0123456789.'.includes(char)) {
            // 数字入力、小数点入力の場合
            if (this.waitingForNext) {
              // 演算子の次の数字を入力待ちの場合
              // 入力値を画面表示(主に上書き)
              this.current = (char === '.' ? '0.' : char);
              // 演算子を入力直後の状態を解除
              this.waitingForNext = false;
            } else {
              // それ以外(「演算子の次の数字を入力済み」または「演算子入力前」)の場合
              // 画面表示の最大長を超えるような文字入力をさせない
              if (this.current.length >= maxLength) return;
            // 2回目の小数点入力なら無視する
            if (char === '.' && this.current.includes('.')) return;
            // 入力値を画面表示(主に追加)
              this.current = (this.current === '0' && char !== '.') ? char : this.current + char;
            }
          } else if ('+-*/'.includes(char)) {
            // 四則演算子入力の場合
            if (this.operator && !this.waitingForNext) {
              // 「演算子入力済み」かつ「演算子の次の数字を入力済み」の場合は計算を実行する
              this.calculate();
            }
            // 計算結果表示済みなので、結果の値を「入力値」に登録する
            this.previous = parseFloat(this.current);
            // 今回入力された演算子を次の計算の演算子として設定する
            this.operator = char;
            // 「演算子の次の値を入力待ち」を設定する
            this.waitingForNext = true;
          } else if ('%'.includes(char)) {
            // %入力の場合(特殊な%演算を行う)
            // 演算の指定により以下の計算結果を新たな数値2の値として表示する
            // 1. 数値1 + 数値2 % → [数値1 * 数値2 * 0.01]
            // 2. 数値1 - 数値2 % → [数値1 * 数値2 * 0.01]
            // 3. 数値1 * 数値2 % → [数値2 * 0.01]
            // 4. 数値1 / 数値2 % → [数値2 * 0.01]
            // ※これ以外の場合(数値1、演算子、数値2が揃わない場合)の%入力は無視する
            // 「演算子入力待ち」または「演算子の前の数字の入力待ち」または「演算子の次の値を入力待ち」の場合は計算をしない
            if (this.operator === null || this.previous === null || this.waitingForNext) return;
            let result = 0;
            switch (this.operator) {
              // 足し算 引き算( → [数値1 * 数値2 * 0.01])
              case '+':
              case '-':
                result = this.previous * parseFloat(this.current) * 0.01; break;
              // かけ算 割り算( → [数値2 * 0.01])
              case '*':
              case '/':
                result = parseFloat(this.current) * 0.01; break;
            }
            // 計算結果の値を上位から画面表示の最大長で切って表示する
            this.current = String(result).slice(0, maxLength);
          }
        },
        // 計算実行
        calculate() {
          console.log("calculate");
          // 「演算子入力待ち」または「演算子の前の数字の入力待ち」の場合は計算をしない
          if (this.operator === null || this.previous === null) return;
          // 画面表示されている数字を数値へ変換する
          const curr = parseFloat(this.current);
          let result = 0;
          // 四則演算を実施する
          switch (this.operator) {
            // 足し算
            case '+': result = this.previous + curr; break;
            // 引き算
            case '-': result = this.previous - curr; break;
            // かけ算
            case '*': result = this.previous * curr; break;
            // 割り算(割る数が0の場合は「Error」表示)
            case '/': result = curr === 0 ? 'Error' : this.previous / curr; break;
          }
          this.current = String(result);
          // 設定された計算を実施済みのため、以下の状態を初期化する
          this.previous = null;                  // 演算子の前の入力値
          this.operator = null;                  // 演算子
          this.waitingForNext = false;           // 演算子の次の値の入力待ち状態
        },
        // オールクリア
        clearAll() {
          console.log("clearAll");
          // 値や状態をすべて初期化する(メモリ以外)
          this.current = '0';               // 現在の表示値
          this.previous = null;             // 演算子の前の入力値
          this.operator = null;             // 演算子
          this.waitingForNext = false;      // 演算子の次の値の入力待ち状態
        },
        // エントリークリア
        clearEntry() {
          console.log("clearEntry");
          // 現在の表示値のみを0へ設定する
          this.current = '0';
          this.operator = null;
        },
        // メモリ加算
        memoryAdd() {
          console.log("memoryAdd");
          // メモリ値に現在の表示値を加算して、メモリ値として再設定する
          this.memory = parseFloat(this.current);
        },
        // メモリ減算
        memorySubtract() {
          console.log("memorySubtract");
          // メモリ値から現在の表示値を減算して、メモリ値として再設定する
          this.memory = -parseFloat(this.current);
        },
        // メモリ読み出し
        memoryRecall() {
          console.log("memoryRecall");
          // メモリ値を現在の表示値へ反映する
          this.current = String(this.memory);
          this.waitingForNext = true;
        },
        // メモリクリア
        memoryClear() {
          console.log("memoryClear");
          // メモリ値を0に設定する
          this.memory = 0;
        }
      }
    });
  </script>
</body>
</html>
